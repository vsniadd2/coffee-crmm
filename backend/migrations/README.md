# Миграции БД

## Автоматическое применение

**Миграции выполняются при каждом запуске backend** — в том числе при обычном `docker compose up` или `docker compose start` (без пересборки и без удаления контейнеров).

При старте backend:
1. Читает все `.sql` файлы из папки `migrations/` (сортировка по имени: 000_..., 001_..., 002_...)
2. Применяет только те миграции, которых ещё нет в таблице `schema_migrations`
3. Данные не удаляются — обновляется только структура (таблицы, колонки, индексы)
4. **Вся схема БД задаётся только файлами в `migrations/`**, в коде приложения миграций нет

## Добавление новой миграции

1. Создай файл `NNN_описание.sql` (например `002_add_points.sql`)
2. Имена сортируются по алфавиту — каждая миграция выполняется один раз
3. Используй только **безопасные** команды:
   - `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` — добавить колонку
   - `CREATE TABLE IF NOT EXISTS` — создать таблицу
   - `CREATE INDEX IF NOT EXISTS` — создать индекс
   - **Избегай** `DROP`, `TRUNCATE`, `DELETE` без условия

## Пример

```sql
-- 002_add_new_column.sql
ALTER TABLE clients ADD COLUMN IF NOT EXISTS phone VARCHAR(50);
```

## Отслеживание

Применённые миграции записываются в таблицу `schema_migrations`.
Повторно не выполняются.
